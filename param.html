<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>パラメータ確認</title>
	</head>
	<body>
		<h1>パラメータ確認 b</h1>
        <video autoplay></video>
        <!--<input type="range" id="rangezoom" hidden>-->
        <p>zoom <input type="range" id="rangezoom"></p>
        <p>解像度 <input type="range" id="rangeres"></p>
        <div>
            <canvas id='takePhotoCanvas'></canvas>
            <button id='takePhotoButton' disabled>Take Photo</button>
        </div>
        
        <h3>Output</h3>
        <div id="output"></div>

        
<script>
//    window.onload = function() {
//        document.querySelector('#log').textContent = 'aaaaauoeadf';
//    };
    document.querySelector('#output').innerHTML += '<div>' + 'start.' + '</div>';
    
    var imageCapture;
    navigator.mediaDevices.getUserMedia({video: true})
    .then(async mediaStream => {
        document.querySelector('#output').innerHTML += '<div>' + 'gotMedia start' + '</div>';
        document.querySelector('video').srcObject = mediaStream;
        // crbug.com/711524
        //await new Promise(r => setTimeout(r, 1000);
        await sleep(1000);

        const mediaStreamTrack = mediaStream.getVideoTracks()[0];
        
        const capabilities = mediaStreamTrack.getCapabilities();
        const settings = mediaStreamTrack.getSettings();
        // if (capabilities.zoom) {
        //     document.querySelector('#output').innerHTML += '<div>' + 'false capabilities.zoom:' + capabilities.zoom + '</div>';
        // }
        // if (!('zoom' in capabilities)) {
        //     document.querySelector('#output').innerHTML += '<div>' + 'in not capabilities.zoom:' + capabilities.zoom + '</div>';
        // }else{
        //     document.querySelector('#output').innerHTML += '<div>' + 'in capabilities.zoom:' + capabilities.zoom + '</div>';
        // }
        document.querySelector('#output').innerHTML += '<div>' + 'capabilities:' + capabilities + '</div>';
        document.querySelector('#output').innerHTML += '<div>' + 'capabilities.zoom:' + capabilities.zoom + '</div>';
        document.querySelector('#output').innerHTML += '<div>' + 'capabilities.brightness:' + capabilities.brightness + '</div>';
        document.querySelector('#output').innerHTML += '<div>' + 'capabilities.contrast:' + capabilities.contrast + '</div>';
        document.querySelector('#output').innerHTML += '<div>' + 'capabilities.torch:' + capabilities.torch + '</div>';

        imageCapture = new ImageCapture(mediaStreamTrack);
        console.log(imageCapture);
        document.querySelector('#output').innerHTML += '<div>' + 'gotMedia end' + '</div>';
    })
    .catch(error => console.error('getUserMedia() error:', error));
    
    function onTakePhotoButtonClick() {
        imageCapture.takePhoto()
        .then(blob => createImageBitmap(blob))
        .then(imageBitmap => {
            const canvas = document.querySelector('#takePhotoCanvas');
            drawCanvas(canvas, imageBitmap);
        })
        .catch(error => console.error('takePhoto() error:', error));
    }

/* Utils */
    function sleep(ms = 0) {
        return new Promise(r => setTimeout(r, ms));
    }
    function drawCanvas(canvas, img) {
        canvas.width = getComputedStyle(canvas).width.split('px')[0];
        canvas.height = getComputedStyle(canvas).height.split('px')[0];
        let ratio  = Math.min(canvas.width / img.width, canvas.height / img.height);
        let x = (canvas.width - img.width * ratio) / 2;
        let y = (canvas.height - img.height * ratio) / 2;
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,
            x, y, img.width * ratio, img.height * ratio);
    }
    
    document.querySelector('#takePhotoButton').addEventListener('click', onTakePhotoButtonClick);
    document.querySelector('video').addEventListener('play', function() {
        document.querySelector('#takePhotoButton').disabled = false;
    })
//    navigator.mediaDevices.getUserMedia({video: true})
//    .then(async mediaStream => {
//      document.querySelector('video').srcObject = mediaStream;
//
//      // Once crbug.com/711524 is fixed, we won't need to wait anymore. This is
//      // currently needed because capabilities can only be retrieved after the
//      // device starts streaming. This happens after and asynchronously w.r.t.
//      // getUserMedia() returns.
//      await sleep(1000);
//
//      const track = mediaStream.getVideoTracks()[0];
//      const capabilities = track.getCapabilities();
//      const settings = track.getSettings();
//        
//      document.querySelector('#output').innerHTML += '<div>' + 'getCapabilities.' + '</div>';
//      //const input = document.querySelector('input[type="range"]');
//      const input = document.getElementById('rangezoom');
//
//      // Check whether zoom is supported or not.
//      if (!('zoom' in capabilities)) {
//          document.querySelector('#output').innerHTML += '<div>' + 'Zoom is not supported.' + track.label + '</div>';
////          return Promise.reject('Zoom is not supported by ' + track.label);
//      }else{
//          document.querySelector('#output').innerHTML += '<div>' + 'Zoom is supported.' + track.label + '</div>';
//      }
//        
//    })
    
    
    //var str = document.querySelector('#output').textContent;
    document.querySelector('#output').innerHTML += '<div>' + 'end.' + '</div>';

</script>

	</body>
</html>